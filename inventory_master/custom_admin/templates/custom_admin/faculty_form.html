{% extends 'custom_admin/base.html' %}
{% block title %}{% if form.instance.pk %}Редактирование факультета{% else %}Создание факультета{% endif %}{% endblock %}
{% block content %}
    <h1>{% if form.instance.pk %}Редактирование факультета{% else %}Создание факультета{% endif %}</h1>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_building" class="form-label">Корпус</label>
            {{ form.building }}
            {{ form.building.errors }}
        </div>
        <div class="mb-3">
            <label for="id_floor" class="form-label">Этаж</label>
            {{ form.floor }}
            {{ form.floor.errors }}
        </div>
        <div class="mb-3">
            <label for="{{ form.name.id_for_label }}" class="form-label">Название факультета</label>
            {{ form.name }}
            {{ form.name.errors }}
        </div>
        <div class="mb-3">
            <label for="{{ form.photo.id_for_label }}" class="form-label">Фото факультета</label>
            {{ form.photo }}
            {{ form.photo.errors }}
        </div>
        <button type="submit" class="btn btn-primary">Сохранить</button>
        <a href="{% url 'custom_admin:faculty_list' %}" class="btn btn-secondary">Отмена</a>
    </form>

    <script>
        // Функция для загрузки этажей
        function loadFloors() {
            const buildingSelect = document.getElementById('id_building');
            const floorSelect = document.getElementById('id_floor');
            
            if (!buildingSelect || !floorSelect) {
                console.error('Селекторы не найдены');
                return;
            }
            
            const buildingId = buildingSelect.value;
            
            if (!buildingId) {
                // Если корпус не выбран, очищаем список этажей
                floorSelect.innerHTML = '<option value="">---------</option>';
                return;
            }
            
            // Запрашиваем этажи для выбранного корпуса
            fetch(`/custom_admin/load-floors/?building=${buildingId}`)
                .then(response => response.json())
                .then(data => {
                    // Сохраняем текущее значение
                    const currentFloorId = floorSelect.value;
                    
                    // Очищаем текущий список
                    floorSelect.innerHTML = '<option value="">---------</option>';
                    
                    // Заполняем списком этажей
                    data.floors.forEach(floor => {
                        const option = document.createElement('option');
                        option.value = floor.id;
                        option.textContent = floor.number;
                        
                        // Восстанавливаем выбранное значение
                        if (floor.id == currentFloorId) {
                            option.selected = true;
                        }
                        
                        floorSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка загрузки этажей:', error);
                });
        }
        
        // Вызываем функцию при загрузке страницы, если корпус уже выбран
        document.addEventListener('DOMContentLoaded', function() {
            const buildingSelect = document.getElementById('id_building');
            if (buildingSelect && buildingSelect.value) {
                loadFloors();
            }
        });
    </script>
{% endblock %}